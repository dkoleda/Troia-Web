{% extends "skeleton/_base.html" %}
{% hyde
    title: "Java client tutorial"
%}

{% block content %}

<div class="row-fluid">
    <div class="span12">
{% restructuredtext %}

==========================================
Basic Troia implementation tutorial (Java)
==========================================
Tutorial introduction
---------------------
This tutorial covers basic usage of Troia service via it
Java client. In given example user already have acquired 
labels generated by workers and gold labels. Said labels
indicate if websites contain pornographic material so categories 
are "PORN" and "NOT_PORN".

Library installation
--------------------
To use Java client you must download it latest revision
from git-hub. Best way to do that is to download Git software
either from their side at http://git-scm.com or if you are using
Linux with package manager you can simply install git package by
writing :
::

 sudo apt-get install git

Another software that will be necessary is build tool and project manager called
Maven. It can be downloaded from http://maven.apache.org/ or with package
manager like in previous example.
After all required software was downloaded we can get Java client code by 
writing :
::

 git clone git://github.com/10clouds/Troia-Java-Client.git

After that you have to create jar package, to do that you need 
to enter Java client main directory where pom.xml is located 
and call maven with following command :
::

 mvn package

This will create *TroiaJavaClient-1.0.jar* in *target* directory.

Including library in project
----------------------------
This part of tutorial covers how to include this library
in maven based project. If you are using another build 
tool you must search tutorial on adding jars in it.
To add this library in maven you should create folder for local
libraries in your project directory, in this example it will be called
*libs*, then you need to add following dependency to your pom.xml file :
::
 
 <dependency>
  <groupId>TroiaJavaClient</groupId>
  <artifactId>TroiaJavaClient</artifactId>
  <version>1.0</version>
  <scope>system</scope>
  <systemPath>${PWD}/libs/TroiaJavaClient-1.0.jar</systemPath>
 </dependency>

Creating request
----------------
To use Troia you must create request and upload your data to it.
Requests are represented by objects of aptly named class *TroiaRequest* that
allow you to use functionalities located at Troia server.
Each object of TroiaRequest is configured with three parameters

 - Service URL with is address of Troia service
 - Request ID  with is used by Troia to identify requests
 - Timeout that sets time, in milliseconds, after with lack of response from Troia will indicate broke connection

Because request id is used to identify requests it must be unique in scope of Troia server, that means that in your
code each request must have unique pair of service URL and request id. TroiaRequest constructor validates url format
and if it's malformed it throws a exception.
Here is example of code that is used for creation of request for Troia server located on localhost.
::

  try{
   TroiaRequest request = new TroiaRequest("localhost:8080/GetAnotherLabel","PronOrNot",1000);
  }catch(MalformedURLException e){
   System.out.println("Malformed URL of Troia service");
  }

After request was created without exception thrown you can be assured that URL was not malformed
but it don't mean that there is actually Troia server at it. To check if given address is really 
that of Troia service you can use *ping* function with sends simple request and checks if service
at given address is able to process it.
::

 try{
  request.ping();
 }catch(IOException e){
  System.out.println("There is no Troia service at given URL");
 }

If ping was executed without exception thrown you know that you created request to correct address
but still there is one more issue that must be taken care of before uploading data.
As it was already written request id must be unique in Troia server so you must check if there is no
request with given id in server already, to do this you must write following code 
::

 try{
  if(!request.exists()||allowUpdate){
   //DATA UPLOAD CODE 
  }else{
   System.out.println("Request with this id exists and updating is not allowed");
  }
 }catch(IOException e){
  System.out.println("Connection to Troia is broken"); 
 }

We must look at this code in a little more detail as there are two things that 
may not be obvious at first. First of all this part of code is inside try-catch
segment because even if ping confirmed working connection to Troia server it's 
possible for connection to break after that so each functions that uses server
can throw IOException. Another interesting part is "if" statement as beside calling
*exists* function that returns true if request with given id exists at server there
is allowUpdate variable. That is boolean that indicates if you want update existing
request as it is possible to add more labels to already posted and processed request.

Preparing and uploading data
----------------------------
After creating request and testing connection you have to prepare gathered data 
for uploading, to do that you must create *Label* object for each label that you
have gathered. Each label consists of object name , worker name and category name.
After creating collection of labels you can finally send them to server. 
To do that following code must be written
::

 try{
  request.loadLabels(labelsCollection);
 }catch(IOException e){
  System.out.println("Connection to Troia is broken");
 }

Where labelsCollection is of *Collection<Label>* class.
You may also want to upload gold labels, with are objects with correct category 
already associated, as their presence makes quality of labels generated by Troia 
higher. Way of doing this is very similar to adding labels except you must
create *GoldLabel* objects that contains only object and category names.
Code to add gold labels is as follows :
::

 try{
  request.loadGoldLabels(goldLabels);
 }catch(IOException e){
  System.out.println("Connection to Troia is broken");
 }
 
After both, labels and gold labels, have been uploaded to Troia server you
can finally process it and download results.

Processing data and fetching results
------------------------------------
To process uploaded data you have to call *computeBlocking* function that
takes number of iterations with Dawid-Skene algorithm will be run as a parameter.
Three iterations are usually optimal number.
::

 try{
  request.computeBlocking(3);
 }catch(IOException e){
  System.out.println("Connection to Troia is broken");
 }

This code executes Dawid-Skene algorithm, with is heart of Troia projects, three
times on labels uploaded in previous steps. After that Troia server already holds
labels with improved quality but if you want to use them you still have to download 
them from server. Best way to do this is to download all of them at once as using
lot of single object requests will put a lot of strain on server.
To do that you should call following code 
::

 try{
  Map<String,String> labels = request.majorityVotes();
 }catch(IOException e){
  System.out.println("Connection to Troia is broken");
 }

Resulting map associates object name with category name generated by Troia service.  

Downloading tutorial application
--------------------------------
To get application that is ecample of what was discussed here you can get Java client
from github with "with-tutorial" branch. This version of code contains addnotational
folder called "tutorialApp" with is a Java project on it's own. There you should review
source file called TroiaExample.java .

{% endrestructuredtext %}
    </div>
</div>
{% endblock %}
